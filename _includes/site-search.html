<form class="global-header__search" action="">
  <div class="global-header__searchfield">
    <div class="global-header__searchicon">
      <i class="mdi mdi-magnify"></i>
    </div>
    <input class="global-header__input" id="search-form" type="text" name="search" placeholder="Search" autocomplete="off" />
  </div>

  <div class="global-header__searchresult" id="result-area">
    <header class="searchresult__header">
      <i class="mdi mdi-close searchresult__closeicon" id="close-icon"></i>
    </header>
    <div class="container">
      <ul class="list--medium--column" id="result-list"></ul>
    </div>
  </div>
</form>

<script type="text/javascript" src="{{ "/assets/scripts/fetch.js" | relative_url }}"></script>
<script type="text/javascript">
    const endpoint = '{{ "/assets/search.json" | relative_url }}';

    const pages = [];

    fetch(endpoint)
        .then(blob => blob.json())
        .then(data => pages.push(...data))

    function findResults(termToMatch, pages) {
        return pages.filter(item => {
            const regex = new RegExp(termToMatch, 'gi');
            return item.title.match(regex) || item.content.match(regex);
        });
    }

    function displayResults() {
        const resultsArray = findResults(this.value, pages);
        const html = resultsArray.map(item => {
          return `
              <li class="frame--small">
                <a href="${item.url}" class="frame__link">
                  <h3>${item.title}</h3>
                  <div class="frame__contents">
                    <p>${item.excerpt.slice(0,140)}</p>
                  </div>
                </a>
              </li>`;
        }).join('');
        if ((resultsArray.length == 0) || (this.value == '')) {
            resultsList.innerHTML = `<p>Sorry, nothing was found</p>`;
        } else {
            resultsList.innerHTML = html;
        }
        resultArea.classList.add('open');
    }

    const field = document.querySelector('#search-form');
    const resultsList = document.querySelector('#result-list');
    const closeIcon = document.querySelector('#close-icon');
    const resultArea = document.querySelector('#result-area');

    field.addEventListener('keyup', displayResults);

    field.addEventListener('keypress', function(event) {
        if (event.keyCode == 13) {
          event.preventDefault();
        }
    });

    closeIcon.addEventListener('click', function(event) {
      if(resultArea.classList.contains('open')) {
        resultArea.classList.remove('open');
      } else {
        resultArea.classList.add('open');
      }
    });
</script>
<noscript>Please enable JavaScript to use the search form.</noscript>
